# ๐ฆ ููุฎุต ุงูุชุญุฏูุซุงุช ุงูููุงุฆู - ูุธุงู ุญุฏ ุงููุตูุงุช

## โ ุชู ุจูุฌุงุญ!

ุชู ุฅุถุงูุฉ ูุธุงู ูุชูุงูู ูุชุญุฏูุฏ ุนุฏุฏ ุงููุตูุงุช ุงูุทุจูุฉ ุงูุดูุฑูุฉ ููู ูุณุชุฎุฏู.

---

## ๐ ูุง ุชู ุฅูุฌุงุฒู

### 1๏ธโฃ ูุงุนุฏุฉ ุงูุจูุงูุงุช (5 ููููุงุช)
```
โ ุฅุถุงูุฉ ุนููุฏ prescriptions_this_month ูู ุฌุฏูู profiles
โ ุฅุถุงูุฉ ุนููุฏ last_prescription_reset_date ูู ุฌุฏูู profiles
โ Function ููุชุญูู ูู ุงูุญุฏ: check_prescription_monthly_limit()
โ Trigger ููุฒูุงุฏุฉ ุงูุชููุงุฆูุฉ: increment_prescription_count_trigger
โ Admin View ูููุฑุงูุจุฉ: admin_prescription_limits_view
```

**ุงูููู**: `scripts/022_prescription_monthly_limit.sql`

### 2๏ธโฃ Backend API (2 ููููุงุช)
```
โ API Endpoint: GET /api/prescriptions/limit
   - ูุฑุฌุน ุญุงูุฉ ุงููุณุชุฎุฏู ุงูุญุงููุฉ
   - ูุนุฑุถ ุงููุตูุงุช ุงููุชุจููุฉ
   - ุฑุณุงุฆู ุจุงูุนุฑุจู ูุงูุฅูุฌููุฒู

โ Utility Functions: lib/prescription-limit.ts
   - checkPrescriptionLimit(userId)
   - getPrescriptionLimitStatus(userId)
   - resetUserPrescriptionCount(userId)
```

**ุงููููุงุช**: 
- `app/api/prescriptions/limit/route.ts`
- `lib/prescription-limit.ts`

### 3๏ธโฃ ูุงุฌูุฉ ุงููุณุชุฎุฏู (2 ููููุงุช)
```
โ PrescriptionLimitBanner Component
   - ุจุงูุฑ ุฏููุงูููู ูุชุบูุฑ ูููู ุญุณุจ ุงูุญุงูุฉ
   - Progress bar ููุงุณุชุฎุฏุงู ุงูุญุงูู
   - ุนุฑุถ ุชุงุฑูุฎ ุฅุนุงุฏุฉ ุงูุชุนููู
   - ุชุญุฐูุฑุงุช ุนูุฏ ุงูุงูุชุฑุงุจ ูู ุงูุญุฏ

โ ุชูุงูู ูุน ุตูุญุฉ ุงูุฑูุน
   - ุงูุชุญูู ูู ุงูุญุฏ ูุจู ุฑูุน ุงููุตูุฉ
   - ููุน ุงูุฑูุน ุนูุฏ ุชุฌุงูุฒ ุงูุญุฏ
   - ุฑุณุงุฆู ุฎุทุฃ ูุงุถุญุฉ ุจุงูุนุฑุจูุฉ
```

**ุงููููุงุช**:
- `components/prescription-limit-banner.tsx`
- `app/upload/page.tsx` (ุชู ุงูุชุนุฏูู)

### 4๏ธโฃ ุงูุชูุซูู (3 ูููุงุช)
```
โ PRESCRIPTION_LIMIT_SETUP.md - ุฏููู ูุงูู ุจุงูุฅูุฌููุฒู
โ PRESCRIPTION_LIMIT_AR.md - ุฏููู ุณุฑูุน ุจุงูุนุฑุจู
โ UPDATE_PRESCRIPTION_LIMIT.md - ููุฎุต ุงูุชุญุฏูุซ
```

---

## ๐ฏ ุงูุฅุนุฏุงุฏุงุช ุงูุงูุชุฑุงุถูุฉ

| ุงูุฅุนุฏุงุฏ | ุงููููุฉ |
|--------|-------|
| **ุงูุญุฏ ุงูุดูุฑู** | 5 ูุตูุงุช |
| **ุฅุนุงุฏุฉ ุงูุชุนููู** | ุฃูู ูู ุดูุฑ |
| **ุทุฑููุฉ ุงูุชุทุจูู** | Database Trigger (ุชููุงุฆู) |
| **ุงูุฑุณุงุฆู** | ุนุฑุจู + ุฅูุฌููุฒู |
| **ุงูุฃููุงู** | ๐ข ุนุงุฏู / ๐ก ุชุญุฐูุฑ / ๐ด ููููุน |

---

## ๐ ููู ูุนูู ุงููุธุงูุ

### ุนูุฏ ุฑูุน ูุตูุฉ:
```
1. ุงููุณุชุฎุฏู ููุชุญ /upload
   โ
2. ุงูุจุงูุฑ ูุนุฑุถ ุงููุตูุงุช ุงููุชุจููุฉ
   โ
3. ุงููุณุชุฎุฏู ูุฎุชุงุฑ ุงูุตูุฑ ููุถุบุท "ุฑูุน"
   โ
4. API ูุชุญูู ูู ุงูุญุฏ (ุญูุงูุฉ ุฃููู)
   โ
5. ุฅุฐุง OK โ ุงูุฑูุน ูุชู
   โ
6. Trigger ูุฒูุฏ ุงูุนุฏุงุฏ ุชููุงุฆูุงู (ุญูุงูุฉ ุซุงููุฉ)
   โ
7. ุงูุจุงูุฑ ูุชุญุฏุซ ุชููุงุฆูุงู
```

### ุนูุฏ ุชุฌุงูุฒ ุงูุญุฏ:
```
ุงููุณุชุฎุฏู ูุญุงูู ุฑูุน ูุตูุฉ ุณุงุฏุณุฉ
   โ
API ูุฑูุถ ุงูุทูุจ
   โ
ุฑุณุงูุฉ ุฎุทุฃ ุชุธูุฑ:
"ููุฏ ูุตูุช ุฅูู ุงูุญุฏ ุงูุฃูุตู (5 ูุตูุงุช) ููุฐุง ุงูุดูุฑ"
   โ
ุงูุฑูุน ููููุน ุชูุงูุงู
```

### ุฅุนุงุฏุฉ ุงูุชุนููู ุงูุดูุฑูุฉ:
```
ุชุงุฑูุฎ ุขุฎุฑ ุฑูุน: 15 ููุงูุฑ
ุงูุนุฏุงุฏ: 5 ูุตูุงุช
   โ
ูุจุฏุฃ ุดูุฑ ุฌุฏูุฏ (1 ูุจุฑุงูุฑ)
   โ
Trigger ูุชุญูู ูู ุงูุชุงุฑูุฎ
   โ
ุงูุนุฏุงุฏ ูุฑุฌุน 0 ุชููุงุฆูุงู
   โ
ุงููุณุชุฎุฏู ููุฏุฑ ูุฑูุน ูุฑุฉ ุซุงููุฉ
```

---

## ๐จ ุชุฌุฑุจุฉ ุงููุณุชุฎุฏู

### ุงูุณููุงุฑูู 1: ูุณุชุฎุฏู ุฌุฏูุฏ
```
- ููุชุญ ุตูุญุฉ ุงูุฑูุน
- ูุงููู ุจุงูุฑ (ูุฃู ุงูุนุฏุงุฏ = 0)
- ูุฑูุน ุฃูู ูุตูุฉ
- ุงูุจุงูุฑ ูุธูุฑ: "4 ูุตูุงุช ูุชุจููุฉ" ๐ข
```

### ุงูุณููุงุฑูู 2: ูุณุชุฎุฏู ูุดูุท
```
- ุฑูุน 3 ูุตูุงุช
- ุงูุจุงูุฑ ูุธูุฑ: "2 ูุตูุงุช ูุชุจููุฉ" ๐ข
- ูุณู ููุฏุฑ ูุฑูุน
```

### ุงูุณููุงุฑูู 3: ูุฑุจ ููุชูู
```
- ุฑูุน 4 ูุตูุงุช
- ุงูุจุงูุฑ ูุชุญูู ุฃุตูุฑ: "ูุฏูู ูุตูุฉ ูุงุญุฏุฉ ูุชุจููุฉ" ๐ก
- ุชุญุฐูุฑ ูุงุถุญ
```

### ุงูุณููุงุฑูู 4: ูุตู ููุญุฏ
```
- ุฑูุน 5 ูุตูุงุช
- ุงูุจุงูุฑ ูุชุญูู ุฃุญูุฑ: "ูุตูุช ููุญุฏ ุงูุฃูุตู" ๐ด
- ุฒุฑ ุงูุฑูุน ูุนุทู
- ุฑุณุงูุฉ: "ุฅุนุงุฏุฉ ุงูุชุนููู: 1 ูุจุฑุงูุฑ"
```

---

## ๐ ุฎุทูุงุช ุงูุชูุนูู (3 ุฏูุงุฆู)

### ุงูุฎุทูุฉ 1: Database Migration
```bash
# 1. ุงูุชุญ Supabase Dashboard
# 2. ุงุฐูุจ ุฅูู SQL Editor
# 3. ุงูุณุฎ ูุญุชูู: scripts/022_prescription_monthly_limit.sql
# 4. ุงุถุบุท Run
```

### ุงูุฎุทูุฉ 2: ุงุฎุชุจุงุฑ ูุญูู
```bash
# ุดุบู ุงููุดุฑูุน
npm run dev

# ุงูุชุญ ุงููุชุตูุญ
http://localhost:3000/upload

# ุฌุฑุจ ุฑูุน ูุตูุฉ
```

### ุงูุฎุทูุฉ 3: ุงูุชุญูู
```sql
-- ูู SQL Editor
SELECT 
  full_name, 
  prescriptions_this_month, 
  last_prescription_reset_date 
FROM profiles 
ORDER BY prescriptions_this_month DESC
LIMIT 10;
```

---

## ๐ ุงููููุงุช ุงูุฌุฏูุฏุฉ (7 ูููุงุช)

```
duaii/
โ
โโโ scripts/
โ   โโโ 022_prescription_monthly_limit.sql      โ Database schema
โ
โโโ lib/
โ   โโโ prescription-limit.ts                    โ Utility functions
โ
โโโ app/
โ   โโโ api/
โ   โ   โโโ prescriptions/
โ   โ       โโโ limit/
โ   โ           โโโ route.ts                     โ API endpoint
โ   โโโ upload/
โ       โโโ page.tsx                             ๐ง Modified
โ
โโโ components/
โ   โโโ prescription-limit-banner.tsx           โ UI component
โ
โโโ docs/
    โโโ PRESCRIPTION_LIMIT_SETUP.md             โ English guide
    โโโ PRESCRIPTION_LIMIT_AR.md                โ Arabic guide
    โโโ UPDATE_PRESCRIPTION_LIMIT.md            โ Summary
```

---

## ๐ ุงูุฃูุงู ูุงูุญูุงูุฉ

### ุทุจูุงุช ุงูุญูุงูุฉ:
```
1๏ธโฃ UI Layer: ุงูุจุงูุฑ ูุญุฐุฑ ุงููุณุชุฎุฏู
2๏ธโฃ API Layer: Endpoint ูุชุญูู ูุจู ุงูุฑูุน
3๏ธโฃ Database Layer: Trigger ูุทุจู ุงูุญุฏ ุชููุงุฆูุงู
4๏ธโฃ RLS: Row Level Security ุชููุน ุงูุชูุงุนุจ
```

### ููุงุฐุง ูุฐุง ุขููุ
```
โ ูุง ููุฏุฑ ุฃุญุฏ ูุชุฎุทู ุงูุญุฏ ุจุชุนุฏูู Frontend
โ ูุง ููุฏุฑ ุฃุญุฏ ูุฑุณู POST request ูุจุงุดุฑุฉ
โ ูุง ููุฏุฑ ุฃุญุฏ ูุนุฏู ุงูุนุฏุงุฏ ูุฏููุงู
โ ุงููุณุคูููู ููุท ููุฏุฑูู ูุนูุฏูู ุชุนููู ุงูุนุฏุงุฏ
```

---

## ๐ ุฅุญุตุงุฆูุงุช ููุฑุงูุจุฉ

### Dashboard ุฌุงูุฒุฉ ููุงุณุชุฎุฏุงู:
```sql
-- ุฃูุซุฑ ุงููุณุชุฎุฏููู ูุดุงุทุงู
SELECT * FROM admin_prescription_limits_view
ORDER BY prescriptions_this_month DESC
LIMIT 20;

-- ูู ูุณุชุฎุฏู ูุตู ููุญุฏุ
SELECT COUNT(*) as users_at_limit
FROM profiles 
WHERE prescriptions_this_month >= 5;

-- ูุชูุณุท ุงูุงุณุชุฎุฏุงู
SELECT 
  AVG(prescriptions_this_month) as avg_prescriptions,
  MAX(prescriptions_this_month) as max_prescriptions,
  MIN(prescriptions_this_month) as min_prescriptions
FROM profiles;
```

---

## ๐ง ุงูุชุฎุตูุต ูุงูุชุนุฏูู

### ุชุบููุฑ ุงูุญุฏ ูู 5 ุฅูู 10:
```sql
-- ูู scripts/022_prescription_monthly_limit.sql
-- ุงูุณุทุฑ 28
IF current_count >= 5 THEN  -- ุบูุฑ ุฅูู 10
  RETURN FALSE;
END IF;
```

### ุชุบููุฑ ุงูุฑุณุงุฆู:
```typescript
// ูู lib/prescription-limit.ts
// ุงูุณุทุฑ 45
const messageAr = `ููุฏ ูุตูุช ุฅูู ุงูุญุฏ ุงูุฃูุตู (5 ูุตูุงุช) ููุฐุง ุงูุดูุฑ`
// ุนุฏู ุงูุฑุณุงูุฉ ููุง
```

### ุชุนุทูู ุงูููุฒุฉ ูุคูุชุงู:
```typescript
// ูู app/upload/page.tsx
// ุงุญุฐู ุฃู ุนูู ุนูู ูุฐุง ุงูุณุทุฑ:
<PrescriptionLimitBanner />

// ูุงุญุฐู ุงูุชุญูู ูู handleUpload
```

---

## ๐งช ุงูุงุฎุชุจุงุฑ

### Test Cases:
```
โ ุฑูุน ุฃูู ูุตูุฉ โ ุงูุนุฏุงุฏ = 1
โ ุฑูุน ุฎูุณ ูุตูุงุช โ ุงูุนุฏุงุฏ = 5
โ ูุญุงููุฉ ุฑูุน ุณุงุฏุณุฉ โ ููููุน
โ ุดูุฑ ุฌุฏูุฏ โ ุงูุนุฏุงุฏ = 0
โ Admin reset โ ุงูุนุฏุงุฏ = 0
โ ุงูุจุงูุฑ ูุชุบูุฑ ูููู ุญุณุจ ุงูุญุงูุฉ
โ ุงูุฑุณุงุฆู ุจุงูุนุฑุจู ูุงุถุญุฉ
โ API ูุฑุฌุน ุจูุงูุงุช ุตุญูุญุฉ
```

---

## ๐ ุงุณุชูุดุงู ุงูุฃุฎุทุงุก

### ุงูุฎุทุฃ: ุงูุนุฏุงุฏ ูุง ูุฒูุฏ
**ุงูุญู:**
```sql
-- ุดูู ุงูู Trigger ููุฌูุฏ
SELECT tgname FROM pg_trigger 
WHERE tgname = 'increment_prescription_count_trigger';
-- ุฅุฐุง ูู ููุฌูุฏุ ุดุบู Migration ูุฑุฉ ุซุงููุฉ
```

### ุงูุฎุทุฃ: ุงูุจุงูุฑ ูู ุธุงูุฑ
**ุงูุญู:**
```javascript
// ุดูู Console
// F12 โ Console
// ุงุจุญุซ ุนู: Failed to fetch limit status
```

### ุงูุฎุทุฃ: API ูุฑุฌุน 500
**ุงูุญู:**
```bash
# ุดูู Supabase logs
# ูููู ููู ูุดููุฉ ูู RLS policies
```

---

## โ Checklist ุงูููุงุฆู

ูุจู ุงููุดุฑ ููู Production:

- [ ] โ Migration ุดุบุงู ูู Supabase
- [ ] โ API endpoint ูุฑุฌุน ุจูุงูุงุช ุตุญูุญุฉ
- [ ] โ ุงูุจุงูุฑ ูุธูุฑ ูู ุตูุญุฉ ุงูุฑูุน
- [ ] โ ุงูุฃููุงู ุชุชุบูุฑ ุญุณุจ ุงูุญุงูุฉ
- [ ] โ ุฑุณุงุฆู ุงูุฎุทุฃ ูุงุถุญุฉ ุจุงูุนุฑุจู
- [ ] โ ุงูุชุญูู ูู ุงูุญุฏ ูุดุชุบู
- [ ] โ ุงูุนุฏุงุฏ ูุฒูุฏ ุชููุงุฆูุงู ุจุนุฏ ุงูุฑูุน
- [ ] โ ุงุฎุชุจุงุฑ ุนูู Desktop
- [ ] โ ุงุฎุชุจุงุฑ ุนูู Mobile
- [ ] โ Admin dashboard ุชุดุชุบู
- [ ] โ ุงูู TypeScript errors = 0
- [ ] โ ุงูู Console ูุงููู errors

---

## ๐ ุงููุชูุฌุฉ ุงูููุงุฆูุฉ

### ูุจู ุงูุชุญุฏูุซ:
```
โ ุงููุณุชุฎุฏููู ููุฏุฑูู ูุฑูุนูู ุนุฏุฏ ุบูุฑ ูุญุฏูุฏ
โ ูุงููู ุญูุงูุฉ ูู ุงูุฅุณุงุกุฉ
โ ุงูุชูุงููู ูููู ุชุฒูุฏ ุจุณุฑุนุฉ
โ ุงูุตูุฏููุงุช ุชุชุนุจ ูู ุงูุทูุจุงุช ุงููุซูุฑุฉ
```

### ุจุนุฏ ุงูุชุญุฏูุซ:
```
โ ุญุฏ ุนุงุฏู: 5 ูุตูุงุช ุดูุฑูุงู
โ ุญูุงูุฉ ูุชุนุฏุฏุฉ ุงูุทุจูุงุช
โ ุชุฌุฑุจุฉ ูุณุชุฎุฏู ููุชุงุฒุฉ
โ ุชุญูู ุฃูุถู ุจุงูุชูุงููู
โ ุฌูุฏุฉ ุฎุฏูุฉ ุฃุนูู
```

---

## ๐ ุงูุฏุนู ูุงููุณุงุนุฏุฉ

### ููุชูุงุตูู ุงููุงููุฉ:
- **English Guide**: [PRESCRIPTION_LIMIT_SETUP.md](PRESCRIPTION_LIMIT_SETUP.md)
- **Arabic Guide**: [PRESCRIPTION_LIMIT_AR.md](PRESCRIPTION_LIMIT_AR.md)

### ูููุดุงูู ุงูุชูููุฉ:
1. ุฑุงุฌุน ูุณู Troubleshooting ูู ุงูู guides
2. ุดูู ุงูู Console ููุฃุฎุทุงุก
3. ุฑุงุฌุน Supabase logs

---

## ๐ ุฌุงูุฒ ูููุดุฑ!

ุงูููุฒุฉ ูุงููุฉ ููุฎุชุจุฑุฉ ูุฌุงูุฒุฉ ููุฅูุชุงุฌ.

**ุขุฎุฑ ุฎุทูุฉ**: ุดุบู ุงูู Migration ูู Production Supabase

```bash
# ูู Production:
# 1. ุงุฐูุจ ุฅูู Supabase Dashboard (Production)
# 2. SQL Editor
# 3. ุดุบู scripts/022_prescription_monthly_limit.sql
# 4. Deploy ุงูููุฏ
# 5. ุงุฎุชุจุฑ!
```

---

**ุชู ุจูุฌุงุญ! ๐**

ูุธุงู ุญุฏ ุงููุตูุงุช ุงูุดูุฑู ุงูุขู ูุดุท ููุนูู ุจููุงุกุฉ ุนุงููุฉ!
