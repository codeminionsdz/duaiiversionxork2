# โ ุชุญุฏูุซ: ูุธุงู ุญุฏ ุงููุตูุงุช ุงูุดูุฑู

## ๐ ููุฎุต ุงูุชุญุฏูุซ

ุชู ุฅุถุงูุฉ ูุธุงู ูุชูุงูู ูุชุญุฏูุฏ ุนุฏุฏ ุงููุตูุงุช ุงูุทุจูุฉ ุงูุชู ูููู ููู ูุณุชุฎุฏู ุฑูุนูุง ุดูุฑูุงู.

---

## ๐ฏ ุงูููุฒุงุช ุงููุถุงูุฉ

### 1. ูุงุนุฏุฉ ุงูุจูุงูุงุช (Database Layer)
โ ุฌุฏูู ุฌุฏูุฏ ูุชุชุจุน ุงูุนุฏุฏ ุงูุดูุฑู  
โ Trigger ุชููุงุฆู ูุฒูุงุฏุฉ ุงูุนุฏุงุฏ ุนูุฏ ุฑูุน ูุตูุฉ  
โ Function ููุชุญูู ูู ุงูุญุฏ ูุจู ุงูุฑูุน  
โ ุฅุนุงุฏุฉ ุชุนููู ุชููุงุฆูุฉ ูู ุฃูู ูู ุดูุฑ  
โ View ูููุณุคูููู ููุฑุงูุจุฉ ุงูุงุณุชุฎุฏุงู

### 2. Backend API
โ Endpoint ููุชุญูู ูู ุงูุญุฏ: `/api/prescriptions/limit`  
โ ุฏูุงู ูุณุงุนุฏุฉ ูู `lib/prescription-limit.ts`  
โ ุฑุณุงุฆู ุฎุทุฃ ูุงุถุญุฉ ุจุงูุนุฑุจู ูุงูุฅูุฌููุฒู  
โ ุญูุงูุฉ ูู ุงูุชูุงุนุจ (Server-side validation)

### 3. ูุงุฌูุฉ ุงููุณุชุฎุฏู (Frontend)
โ ุจุงูุฑ ุชูุงุนูู ููุถุญ ุงููุตูุงุช ุงููุชุจููุฉ  
โ ุฃููุงู ุชุญุฐูุฑูุฉ ุนูุฏ ุงูุงูุชุฑุงุจ ูู ุงูุญุฏ  
โ ููุน ุงูุฑูุน ูุน ุฑุณุงูุฉ ุฎุทุฃ ุนูุฏ ุชุฌุงูุฒ ุงูุญุฏ  
โ Progress bar ููุถุญ ุงูุงุณุชุฎุฏุงู ุงูุญุงูู  
โ ุนุฑุถ ุชุงุฑูุฎ ุฅุนุงุฏุฉ ุงูุชุนููู ุงููุงุฏู

---

## ๐ ุงููููุงุช ุงููุถุงูุฉ

```
duaii/
โโโ scripts/
โ   โโโ 022_prescription_monthly_limit.sql      # Database migration
โโโ lib/
โ   โโโ prescription-limit.ts                    # Utility functions
โโโ app/
โ   โโโ api/
โ       โโโ prescriptions/
โ           โโโ limit/
โ               โโโ route.ts                     # API endpoint
โโโ components/
โ   โโโ prescription-limit-banner.tsx           # UI component
โโโ PRESCRIPTION_LIMIT_SETUP.md                 # Setup guide (English)
โโโ PRESCRIPTION_LIMIT_AR.md                    # Setup guide (Arabic)
```

**ุชุนุฏููุงุช ุนูู ูููุงุช ููุฌูุฏุฉ:**
- `app/upload/page.tsx`: ุฅุถุงูุฉ ุงูุชุญูู ูู ุงูุญุฏ ูุจู ุงูุฑูุน

---

## ๐ ุทุฑููุฉ ุงูุชูุนูู

### ุงูุฎุทูุฉ 1: ุชุดุบูู Migration
```bash
# ุงูุชุญ Supabase SQL Editor
# ุงูุณุฎ ูุญุชูู scripts/022_prescription_monthly_limit.sql
# ุดุบูู
```

### ุงูุฎุทูุฉ 2: ุงุฎุชุจุงุฑ
```bash
npm run dev
# ุงูุชุญ http://localhost:3000/upload
# ุฌุฑุจ ุฑูุน ูุตูุฉ
```

### ุงูุฎุทูุฉ 3: ุงูุชุฃูุฏ
```sql
-- ุดูู ุงูุนุฏุงุฏ ูุดุชุบู
SELECT 
  full_name, 
  prescriptions_this_month, 
  last_prescription_reset_date 
FROM profiles 
LIMIT 5;
```

---

## ๐จ ููุทุงุช ุงูุดุงุดุฉ

### ุญุงูุฉ ุนุงุฏูุฉ (ุจูู ูุตูุงุช):
```
๐ข 3 ูุตูุงุช ูุชุจููุฉ ูุฐุง ุงูุดูุฑ     2/5
```

### ุชุญุฐูุฑ (ูุฑุจ ููุชูู):
```
๐ก ูุฏูู ูุตูุชุงู ููุท ูุชุจููุชุงู
   โโโโโโโโโโ 4/5
   ๐ ุฅุนุงุฏุฉ ุงูุชุนููู: 1 ููุงูุฑ
```

### ููููุน ุงูุฑูุน (ูุตูุช ููุญุฏ):
```
๐ด ููุฏ ูุตูุช ุฅูู ุงูุญุฏ ุงูุฃูุตู (5 ูุตูุงุช) ููุฐุง ุงูุดูุฑ
   โโโโโโโโโโ 5/5
   ๐ ุฅุนุงุฏุฉ ุงูุชุนููู: 1 ูุจุฑุงูุฑ
```

---

## โ๏ธ ุงูุฅุนุฏุงุฏุงุช ุงููุงุจูุฉ ููุชุนุฏูู

### ุชุบููุฑ ุงูุญุฏ ุงูุดูุฑู:
```sql
-- ูู scripts/022_prescription_monthly_limit.sql
IF current_count >= 5 THEN  -- ุบูุฑ ูุฐุง ุงูุฑูู
```

### ุชุบููุฑ ุฌุฏูู ุฅุนุงุฏุฉ ุงูุชุนููู:
```sql
-- ุงููุถุน ุงูุญุงูู: ุฃูู ูู ุดูุฑ
-- ููุชุบููุฑ: ุนุฏู ุงูุดุฑุท ูู ุงูู Trigger
```

---

## ๐ ุงูุฃูุงู ูุงูุญูุงูุฉ

โ **Server-side validation**: ุงูุญุฏ ููุทุจู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช  
โ **RLS enabled**: ุงููุณุชุฎุฏู ูุดูู ุจูุงูุงุชู ููุท  
โ **Trigger-based**: ูุง ููุฏุฑ ุฃุญุฏ ูุชูุงุนุจ ุจุงูุนุฏุงุฏ  
โ **Admin controls**: ุฏูุงู ุฎุงุตุฉ ูููุณุคูููู ููุท  
โ **Auto-reset**: ุฅุนุงุฏุฉ ุชุนููู ุชููุงุฆูุฉ ูู ุดูุฑ

---

## ๐ ุฅุญุตุงุฆูุงุช ููุฑุงูุจุฉ

### ูุฑุงูุจุฉ ุงูุงุณุชุฎุฏุงู:
```sql
-- ุงููุณุชุฎุฏููู ุงููู ูุตููุง ููุญุฏ
SELECT COUNT(*) 
FROM profiles 
WHERE prescriptions_this_month >= 5;

-- ูุชูุณุท ุงููุตูุงุช ููู ูุณุชุฎุฏู
SELECT AVG(prescriptions_this_month) 
FROM profiles;
```

### Admin Dashboard:
```sql
-- View ุฌุงูุฒุฉ ููุนุฑุถ
SELECT * FROM admin_prescription_limits_view
ORDER BY prescriptions_this_month DESC;
```

---

## ๐งช ุณููุงุฑูููุงุช ุงูุงุฎุชุจุงุฑ

### โ Test Case 1: ุฑูุน ูุตูุฉ ุนุงุฏูุฉ
- ุงููุณุชุฎุฏู ูุฑูุน ูุตูุฉ โ ุงูุนุฏุงุฏ ูุฒูุฏ
- ุงูุจุงูุฑ ูุชุญุฏุซ ุชููุงุฆูุงู

### โ Test Case 2: ุงููุตูู ููุญุฏ
- ุงููุณุชุฎุฏู ูุฑูุน 5 ูุตูุงุช
- ูุญุงููุฉ ุฑูุน ุงูุณุงุฏุณุฉ ุชูุดู
- ุฑุณุงูุฉ ุฎุทุฃ ูุงุถุญุฉ ุชุธูุฑ

### โ Test Case 3: ุฅุนุงุฏุฉ ุงูุชุนููู ุงูุดูุฑูุฉ
- ูู ุฃูู ุงูุดูุฑ ุงูุฌุฏูุฏ
- ุงูุนุฏุงุฏ ูุฑุฌุน ุตูุฑ ุชููุงุฆูุงู
- ุงููุณุชุฎุฏู ููุฏุฑ ูุฑูุน ูุฑุฉ ุซุงููุฉ

### โ Test Case 4: Admin Override
- ุงููุณุคูู ููุฏุฑ ูุนูุฏ ุชุนููู ุนุฏุงุฏ ูุณุชุฎุฏู ูุนูู
- ุงููุณุชุฎุฏู ููุฏุฑ ูุฑูุน ูุฑุฉ ุซุงููุฉ

---

## ๐ ุญู ุงููุดุงูู

### ุงููุดููุฉ: ุงูุนุฏุงุฏ ูุง ูุฒูุฏ
```sql
-- ุดูู ุงูู Trigger
SELECT * FROM pg_trigger WHERE tgname = 'increment_prescription_count_trigger';
-- ุฅุฐุง ูู ููุฌูุฏุ ุดุบู ุงูู Migration ูุฑุฉ ุซุงููุฉ
```

### ุงููุดููุฉ: ุงูุจุงูุฑ ูู ุธุงูุฑ
1. ุชุฃูุฏ ุฅู ุงููุณุชุฎุฏู ูุณุฌู ุฏุฎูู
2. ุดูู ุงูู Console ููุฃุฎุทุงุก
3. ุชุฃูุฏ ุฅู API endpoint ุฑุงุฌุน ุจูุงูุงุช

### ุงููุดููุฉ: ุฅุนุงุฏุฉ ุงูุชุนููู ูุง ุชุดุชุบู
```sql
-- ุฅุนุงุฏุฉ ุชุนููู ูุฏููุฉ
UPDATE profiles 
SET prescriptions_this_month = 0, 
    last_prescription_reset_date = CURRENT_DATE
WHERE last_prescription_reset_date < DATE_TRUNC('month', CURRENT_DATE);
```

---

## ๐ ูุฑุงุฌุน ุฅุถุงููุฉ

- **ุฏููู ุงูุชูุนูู ุงููุงูู**: [PRESCRIPTION_LIMIT_SETUP.md](PRESCRIPTION_LIMIT_SETUP.md)
- **ุฏููู ุจุงูุนุฑุจู**: [PRESCRIPTION_LIMIT_AR.md](PRESCRIPTION_LIMIT_AR.md)
- **API Documentation**: `/api-docs` (Swagger UI)

---

## โ Checklist ูุจู ุงููุดุฑ

- [ ] โ ุดุบูุช SQL Migration
- [ ] โ ุงุฎุชุจุฑุช ุงูุฑูุน ุงูุนุงุฏู
- [ ] โ ุงุฎุชุจุฑุช ุงููุตูู ููุญุฏ
- [ ] โ ุงูุจุงูุฑ ูุธูุฑ ุตุญ
- [ ] โ ุงูุฑุณุงุฆู ุจุงูุนุฑุจู ูุงุถุญุฉ
- [ ] โ ุงุฎุชุจุฑุช ุนูู Desktop ู Mobile
- [ ] โ ุฑุงุฌุนุช ุงูู Console ูุงููู errors
- [ ] โ ุงุฎุชุจุฑุช ุฅุนุงุฏุฉ ุงูุชุนููู ุงูุดูุฑูุฉ

---

## ๐ ุงููุชูุฌุฉ

ุงูุขู ุงููุณุชุฎุฏููู ูุฏููู ุญุฏ ุนุงุฏู ูููุทูู ูุฑูุน ุงููุตูุงุชุ ููุง ูุญูู ุงูููุตุฉ ูู ุงูุฅุณุงุกุฉ ููุญุงูุธ ุนูู ุฌูุฏุฉ ุงูุฎุฏูุฉ ููุฌููุน!

**ุงูุญุฏ ุงูุงูุชุฑุงุถู**: 5 ูุตูุงุช ุดูุฑูุงู  
**ุฅุนุงุฏุฉ ุงูุชุนููู**: ุชููุงุฆูุงู ูู ุฃูู ูู ุดูุฑ  
**ุงูุฑุณุงุฆู**: ูุงุถุญุฉ ุจุงูุนุฑุจู ูุงูุฅูุฌููุฒู

---

**ุชู ุจูุฌุงุญ! ๐**
